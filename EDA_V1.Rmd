---
title: "EDA"
author: "Madalyn Young"
date: "2025-01-27"
output:
    html_document:
    toc: true
    toc-depth: 3
    toc-location: left
    toc-title: "Contents"
    toc_float:
      position: "left"
execute:
  warning: false
  message: false
---

# Introduction


## Data Discovery

```{r}
pacman::p_load(tidyverse, scales, dplyr, corrr, janitor, tidyr, psych, readr)
```

```{r}
CustomerInfo <- read.csv("Data/customer_profile.csv")  
transactionDat <- read.csv("Data/transactional_data.csv")
AddressZip <- read.csv("Data/customer_address_and_zip_mapping.csv")
cost_data <- read.csv("Data/delivery_cost_data.csv")
```

```{r}

# Ensure AddressZip is a data frame with the correct column structure
# Assume the relevant column to split is named 'full_address'

# Split the column
AddressZip <- AddressZip |>
  separate(full.address, into = c("ZIP", "City", "State Name", "State Short", 
                                  "County","Code", "Latitude", "Longitude"), sep = ",")

# View the result
print(AddressZip)

AddressZip[rowSums(is.na(AddressZip)) > 0, ]

```


```{r}
summary(CustomerInfo)
```

CustomerInfo has:

- customer numbers: A primary group number can have multiple customer numbers, indicating that the customer is a part of the chain. SWIRE said that they treat the chain the same. So I think what we will want to do is combined the customer fields into one (if primary group is not null THEN Primary group, else customer number). We might want to look at differences in customers that have multiple outlets, so we might want to create an indicator field for the combined customer column if it has multiple outlets or not. Or count of number of outlets (segment customer groups based on how many outlets they have)


Frequent order type: this is HOW the customer *typically* orders. They can use MyCoke Legacy, which is the original online ordering system. MyCoke360, which is the ordering system that replaced legacy. They can go through a salesrep, a call center. EDI = Electronic Data Interchange

```{r}
unique(CustomerInfo$FREQUENT_ORDER_TYPE)
```

First Delivery Date: the first time SWIRE delivered to the customer

On Boarding Date:  date the customer was on boarded. Not sure what this really entails? Maybe we added them to our system as a customer and then they waited to buy. That would be an interesting thing to look at, how long between a customer was boarded versus their first delivery 

cold drink channel: This is how people order cold cocacola from the customer

```{r}
unique(CustomerInfo$COLD_DRINK_CHANNEL)
```

Trade Channel: This is the type of customer they are. i.e., why type of business they own

```{r}
unique(CustomerInfo$TRADE_CHANNEL)
```

Sub_Trade Channel: This is the sub business. such as pizza, Mexican, sandwiches, etc.
```{r}
unique(CustomerInfo$SUB_TRADE_CHANNEL)
```

Local Market partner: Local market partners are smaller customers that serve people locally and need local analysis and consistent purchase patterns (Boolean)

CO2 Customer: this is the product. You can purchase CO2 which is just the gas and the customer will make the drink themselves


Transaction Data has:

```{r}
summary(transactionDat)
```

Transaction Date: This is the date the transaction was ordered

Week: just 1 to 52. what week of the year was the transaction ordered. Can we create a variable here to show how many weeks out of they year a customer orders? I wonder if there are any customers that order more than once a week?

Year: this data only goes back 2 years 

Customer number: this is the outlet customer number. which means that in order to join the two tables, we cannot disregard the outlet customer number in the first table

Order Type: this is HOW the customer *typically* orders. They can use MyCoke Legacy, which is the original online ordering system. MyCoke360, which is the ordering system that replaced legacy. They can go through a salesrep, a call center. EDI = Electronic Data Interchange
I wonder if we can compare this to the most used and see how often a customer deviates from their most used system of ordering. would that tell s anything? My thought is that it would tell me about less important customers

Ordered cases: This is the number of cases ordered by the customer. summary stats show avg is 26.85 cases, median is 7. which means there are some outlying customers ordering significantly more. I wonder if that is consistent? I wonder if we segregate large quantity ordered customers

Loaded Cases: Number of cases loaded for delivery. The average here is a little less. Median is the same. How does this differ from ordered? If we cant meet the order, where does the customer go to get the quantity needed? How often is this not equaling the ordered cases? for which type of customers is that happening (larger)?

Delivered cases: This is how many cases are delivered to the customer. same questions as above...can a customer change the quantity at delivery or is this on SWIRE?

"If the delivered is 0 and order is not then you can assume they did not get their order" 

3 Gallons metrics the same as above.


Customer Profile has:

```{r}
summary(custAddress)
```

Only the zip code and the full address. This data is not real. but maybe we can still use it in some capacity to find fake segmentation and patterns among customers. Might want to pull out state and county from the address into their own columns



What is our train and test set going to look like? 1 for if they are a growth customer. But how do we define that? large volume currently? % growth over the last two years?
- Create a variable that shows if customer is ordering 400 G in 2023 and 2024 and if that is a 1 in both years then they are good customers 

Cost Date:

```{r}
summary(cost_data)
```





## Task 1 
### create a target variable

I want to create a target variable to identify all customers that are above the threshold

we might want a target variable that shows if the customer grew over the two years

```{r}
CustomerInfo <- CustomerInfo %>% 
  mutate(CustCombined = case_when(is.na(PRIMARY_GROUP_NUMBER) ~ CUSTOMER_NUMBER, TRUE ~ PRIMARY_GROUP_NUMBER) )
```

There are 30,478 unique customer numbers. Grouping by the primary customer (customers with more than one outlet) there are 19,216

```{r}
length(unique(CustomerInfo$CustCombined))
length(unique(CustomerInfo$CUSTOMER_NUMBER))
```



```{r}
cust_orders_Joined <- CustomerInfo %>% left_join(transactionDat, by = "CUSTOMER_NUMBER") 

cust_orders_Joined$TRANSACTION_DATE <- mdy(cust_orders_Joined$TRANSACTION_DATE)

options(scipen = 999)
cust_orders_Joined %>% 
  filter((YEAR == 2023) ) %>% 
  group_by(CustCombined) %>% 
  summarize(sum_value = sum(ORDERED_GALLONS, ORDERED_CASES)) %>% 
  arrange(desc(sum_value))
  
cust_orders_Joined %>% 
  filter(YEAR == 2023) %>% 
  group_by(CustCombined) %>% 
  summarize(sum_value = sum(ORDERED_GALLONS, ORDERED_CASES)) %>% 
  arrange(desc(sum_value))

```


```{r}
#aggregated  transaction data to join to customer table

aggregatedCost <- transactionDat %>% 

  group_by(CUSTOMER_NUMBER, YEAR) %>% 
  summarize(orderedCases = sum(ORDERED_CASES),
            loadedCases = sum(LOADED_CASES),
            deliveredCases = sum(DELIVERED_CASES),
            orderedGallons = sum(ORDERED_GALLONS),
            loadedGallons = sum(LOADED_GALLONS),
            deliveredGallons = sum(DELIVERED_GALLONS))


aggregatedCost_wide <- aggregatedCost %>%
  pivot_wider(
    names_from = YEAR, 
    values_from = c(orderedCases, loadedCases, deliveredCases, 
                    orderedGallons, loadedGallons, deliveredGallons),
    names_sep = "_"
  )
```



```{r}
#this is customer by outlet
cust_orders_target <- CustomerInfo %>% 
  left_join(aggregatedCost_wide, by = "CUSTOMER_NUMBER") %>% 
  mutate(targetVariable = case_when(orderedGallons_2023>= 400 ~ 1, orderedGallons_2024>=400 ~ 1, TRUE ~ 0), 
  percentChangeYOY = (orderedGallons_2024 - orderedGallons_2023)/orderedGallons_2023)
```

i looked at a customer that had a 333% growth but the number of gallons ordered was minimal. I think this would be a great target to look at to identify growth customers that might be below the 400 gallon threshold

```{r}
parent_cust_orders <- CustomerInfo %>% 
  left_join(aggregatedCost_wide, by = "CUSTOMER_NUMBER") %>% 
  mutate(across(c(orderedCases_2023, orderedCases_2024, orderedGallons_2023, orderedGallons_2024), ~ replace_na(.x, 0))) %>% 
  group_by(CustCombined) %>% 
  summarize(orderedCases_2023 = sum(orderedCases_2023),
            orderedCases_2024 = sum(orderedCases_2024),
            loadedCases_2023 = sum(loadedCases_2023),
            loadedCases_2024 = sum(loadedCases_2024),
            deliveredCases_2023 = sum(deliveredCases_2023),
            deliveredCases_2024 = sum(deliveredCases_2024),
            orderedGallons_2023 = sum(orderedGallons_2023),
            orderedGallons_2024 = sum(orderedGallons_2024),
            loadedGallons_2023 = sum(loadedGallons_2023),
            loadedGallons_2024 = sum(loadedGallons_2024),
            deliveredGallons_2023 = sum(deliveredGallons_2023),
            deliveredGallons_2024 = sum(deliveredGallons_2024)) %>% 
  mutate(
    targetVariable = case_when(orderedGallons_2023>= 400 ~ 1, orderedGallons_2024>=400 ~ 1,orderedCases_2023>=400 ~ 1, orderedCases_2024>=400 ~1, TRUE ~ 0), 
  percentChangeYOY = ((orderedGallons_2024+orderedCases_2024) - (orderedGallons_2023+orderedCases_2023))/(orderedGallons_2023+orderedCases_2023))
  
```

according to the slides, one case = one gallon. So we can make the target variable looking at both.

% change for no sales in 2023 but sales in 2024 is inf - Infinite, new business

```{r}
plot(CustCombined~(orderedCases_2023+orderedGallons_2024), parent_cust_orders)
```

```{r}
parent_cust_orders <- parent_cust_orders %>% 
  mutate(across(c(orderedCases_2023, orderedCases_2024, orderedGallons_2023, orderedGallons_2024), ~ replace_na(.x, 0))) %>% 
  mutate(TwoYearThresh = orderedCases_2023+orderedCases_2024+orderedGallons_2023+orderedGallons_2024)

```


```{r}
parent_cust_orders <- parent_cust_orders %>% 
  mutate(ThreshBins = case_when(
    TwoYearThresh <= 800 ~ "Below Threshold",
    TwoYearThresh >= 800 & TwoYearThresh <= 1000 ~ "Around Threshold",
    TwoYearThresh > 1000 & TwoYearThresh <= 10000 ~ "1K-10K",
    TwoYearThresh > 10000 & TwoYearThresh <= 50000 ~ "10K-50K",
    TwoYearThresh > 50000 & TwoYearThresh <= 100000 ~ "50-100K",
    TwoYearThresh > 100000 ~ "Very High") )

```


```{r}
parent_cust_orders %>% 
  ggplot(aes(ThreshBins)) + 
  geom_bar()
```

We have 3914 customers that are over threshold
Remaining 15505 are not.

```{r}
parent_cust_orders %>% 
  filter(ThreshBins == 'Below Threshold') %>% 
  pull(percentChangeYOY) %>%
  is.infinite() %>%
  sum()
```
There are 3189 customers that did not have business in 2023 and started with Swire in 2024 that were below the threshold. There were 3254 all together which means that there are a little under 100 customers that purchased over 800 gallons in that one year. 

```{r}
parent_cust_orders %>% 
  filter((percentChangeYOY == Inf)) #& (ThreshBins != "Below Threshold"))
```
10 customers have outlets


how to use outlet:
# of outlets as a predictor
# has outlet as a predictor
# proportion of the outlets that are performing above threshold for its parent customer
